#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <unistd.h>
#include "../../util/util.h"

int are_arguments_insufficient(int);
void how_to_use(char *, char *);
void write_uid(const int);
void write_note(const int, void *);

int main(int argc, char *argv[])
{
	int file_descriptor;
	char *buffer, *filename;

	buffer = (char *) checked_malloc(100);
	filename = (char *) checked_malloc(50);

	strcpy(filename, "notes.txt");
	strcpy(buffer, argv[1]);

	if(are_arguments_insufficient(argc))
	{
		how_to_use(argv[0], filename);
	}

	file_descriptor = open(filename, O_WRONLY|O_CREAT|O_APPEND, S_IRUSR|S_IWUSR);
	if(file_descriptor == -1)
	{
		fatal_error("in main() while opening the file");
	}

	write_uid(file_descriptor);
	write_note(file_descriptor, buffer);

	if(close(file_descriptor) == -1){
		fatal_error("in main() while closing the file");
	}

	printf("Your note has been saved successfully. \n");
	free(buffer);
	free(filename);

	return 1;
}

int are_arguments_insufficient(int arguments_count){
	return arguments_count < 2;
}

void how_to_use(char *program_name, char *file_name){
	printf("Usage: %s <text to be added in %s> \n", program_name, file_name);
	exit(0);
}

void write_uid(const int file_descriptor)
{
	int current_user_id = getuid();
	int uid_write_result_code = write(file_descriptor, &current_user_id, sizeof(current_user_id));
	int new_line_write_result_code = write(file_descriptor, "\n", 1);

	if(uid_write_result_code < 0 || new_line_write_result_code < 0)
		fatal_error("in main() while writing the UID");
}

void write_note(const int file_descriptor, void *buffer)
{
	int note_write_result_code = write(file_descriptor, buffer, strlen( (char *) buffer ));
	int new_line_write_result_code = write(file_descriptor, "\n", 1);

	if(note_write_result_code < 0 || new_line_write_result_code < 0)
		fatal_error("in main() while writing the note");
}
