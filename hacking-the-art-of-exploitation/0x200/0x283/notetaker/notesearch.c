#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <fcntl.h>
#include <sys/stat.h>
#include "../../util/util.h"

#define FILENAME "notes.txt"

int print_notes(int, int, char *);
int find_user_note(int, int);
int search_note(char *, char *);

int main(int arg_count, char *arg_values[])
{
	int user_id;
	int is_printing;
	int file_descriptor;
	char search_string[100];

	if(arg_count > 1)
		strcpy(search_string, arg_values[1]);
	else
		search_string[0] = '\0';

	user_id = getuid();

	file_descriptor = open(FILENAME, O_RDONLY);
	if(file_descriptor == -1)
		fatal_error("in main() while trying to open the file");

	do
		is_printing = print_notes(file_descriptor, user_id, search_string);
	while (is_printing);

	printf("[ end of note data ]");
	close(file_descriptor);

	return 1;
}

int print_notes(int file_descriptor, int user_id, char *search_string)
{
	int note_length;
	char note_buffer[100];

	note_length = find_user_note(file_descriptor, user_id);
	if(note_length == -1)
		return 0;

	read(file_descriptor, note_buffer, note_length);
	note_buffer[note_length] = '\0';

	if(search_note(note_buffer, search_string))
		printf("%s", note_buffer);

	return 1;
}

int find_user_note(int file_descriptor, int user_id)
{
	int note_user_id = -1;
	unsigned char byte;
	int length;

	while(note_user_id != user_id)
	{
		if(read(file_descriptor, &note_user_id, sizeof(int)) != 4)
			return -1;

		if(read(file_descriptor, &byte, sizeof(unsigned char)) != 1)
			return -1;

		byte = length = 0;
		while(byte != '\n')
		{
			if(read(file_descriptor, &byte, sizeof(unsigned char)) != 1)
				return -1;

			length++;
		}
	}

	lseek(file_descriptor, length * 1, SEEK_CUR);

	printf("[DEBUG] found a %d byte note for user id %d \n", length, note_user_id);

	return length;
}

int search_note(char *note, char *keyword)
{
	int i, keyword_length, match = 0;

	keyword_length = strlen(keyword);
	if(keyword_length == 0)
		return 1;

	for(i = 0; i < strlen(note); i++)
	{
		if(note[i] == keyword[match])
			match++;
		else 
		{
			if(note[i] == keyword[0])
				match = 1;
			else
				match = 0;
		}

		if(match == keyword_length)
			return 1;
	}

	return 0;
}