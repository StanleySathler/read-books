#include <stdio.h>
#include <stdlib.h>
#include <string.h>

void *checked_malloc(unsigned int);

int main(int argc, char *argv[]){
	char *pointer_to_char;
	int *pointer_to_int;
	int memory_size = 50;

	if(argc > 1){
		memory_size = atoi(argv[1]);
	}

	printf("\n");

	printf("[+] Allocating %d bytes of memory on the heap segment for *pointer_to_char \n", memory_size);
	pointer_to_char = (char *) checked_malloc(memory_size);
	strcpy(pointer_to_char, "This text is allocated on the memory's heap segment");
	printf("   *pointer_to_char (%p): \"%s\" \n", pointer_to_char, pointer_to_char);

	printf("\n");

	printf("[+] Allocating 12 bytes of memory on the heap segment for *pointer_to_int \n");
	pointer_to_int = (int *) checked_malloc(12);	
	*pointer_to_int = 31337;
	printf("   *pointer_to_int (%p): %d \n", pointer_to_int, *pointer_to_int);

	printf("\n");

	printf("[-] Freeing pointer_to_char's allocated space... \n");
	free(pointer_to_char);

	printf("\n");

	printf("[+] Allocating 40 bytes of memory on the heap segment for *pointer_to_char \n");
	pointer_to_char = (char *) checked_malloc(40);
	strcpy(pointer_to_char, "New text on the memory's heap segment");
	printf("   *pointer_to_char (%p): \"%s\" \n", pointer_to_char, pointer_to_char);

	printf("\n");

	printf("[-] Freeing pointer_to_int's allocated space...\n");
	free(pointer_to_int);
	printf("[-] Freeing pointer_to_char's allocated space...\n");
	free(pointer_to_char);

	printf("\n");
}

void *checked_malloc(unsigned int bytes){
	void *allocated_space = malloc(bytes);
	if(allocated_space == NULL){
		fprintf(stderr, "An error ocurred when trying to allocate %u bytes on heap segment\n", bytes);
		exit(-1);
	}
	return allocated_space;
}
